<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Nearby Bathrooms</title>
  <link rel="preconnect" href="https://unpkg.com">
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
    crossorigin="anonymous"
  />
  <style>
    :root { --bg:#0b1020; --panel:#111834; --ink:#eaf0ff; --muted:#a9b7ff; --accent:#8be9fd; }
    * { box-sizing: border-box; }
    body { margin: 0; font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji"; background: var(--bg); color: var(--ink); }
    header { padding: 12px 16px; display: flex; gap: 12px; align-items: center; justify-content: space-between; border-bottom: 1px solid rgba(255,255,255,.08); background: linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,0)); position: sticky; top: 0; z-index: 10; }
    .brand { font-weight: 700; letter-spacing: .3px; }
    .controls { display: flex; flex-wrap: wrap; gap: 10px; align-items: center; }
    .chip { background: var(--panel); border: 1px solid rgba(255,255,255,.08); padding: 8px 10px; border-radius: 12px; display: flex; align-items: center; gap: 8px; }
    .chip label { font-size: 12px; color: var(--muted); }
    .chip input[type="number"] { width: 80px; padding: 6px 8px; border-radius: 8px; border: 1px solid rgba(255,255,255,.12); background: #0f1631; color: var(--ink); }
    .btn { cursor: pointer; padding: 10px 12px; border-radius: 12px; border: 1px solid rgba(255,255,255,.12); background: #1a2351; color: var(--ink); font-weight: 600; }
    .btn:hover { filter: brightness(1.1); }
    #map { height: calc(100vh - 60px); }
    .sidebar { position: absolute; right: 12px; top: 72px; width: 320px; max-width: calc(100vw - 24px); z-index: 11; background: var(--panel); border: 1px solid rgba(255,255,255,.1); border-radius: 16px; box-shadow: 0 20px 40px rgba(0,0,0,.4); overflow: hidden; }
    .sidebar header { padding: 12px; position: sticky; top: 0; background: rgba(10,15,35,.8); backdrop-filter: blur(10px); border-bottom: 1px solid rgba(255,255,255,.06); }
    #list { max-height: 50vh; overflow: auto; }
    .item { padding: 12px; border-bottom: 1px dashed rgba(255,255,255,.08); }
    .item:last-child { border-bottom: none; }
    .item h4 { margin: 0 0 6px; font-size: 14px; }
    .muted { color: var(--muted); font-size: 12px; }
    .status { font-size: 12px; color: var(--muted); padding: 8px 12px; }
    .leaflet-popup-content { color: #0b1020; }
    .pill { display:inline-block; padding:3px 8px; border-radius:999px; background:#e6f7ff; color:#003a52; font-size:11px; margin-right:6px; }
    @media (max-width: 860px) { .sidebar { position: fixed; left: 12px; right: 12px; top: auto; bottom: 12px; width: auto; } }
  </style>
</head>
<body>
  <header>
    <div class="brand">ðŸš» Nearby Bathrooms</div>
    <div class="controls">
      <div class="chip"><label>Radius (m):</label><input id="radiusInput" type="number" min="200" step="100" value="1000" /></div>
      <div class="chip"><label><input id="wheelchairOnly" type="checkbox" /> Wheelchair</label></div>
      <div class="chip"><label><input id="changingOnly" type="checkbox" /> Changing table</label></div>
      <div class="chip"><label><input id="unisexOnly" type="checkbox" /> Unisex</label></div>
      <button id="refreshBtn" class="btn">Search</button>
    </div>
  </header>

  <div id="map"></div>

  <aside class="sidebar" aria-live="polite">
    <header><strong>Results</strong></header>
    <div id="list"></div>
    <div class="status" id="status">Waiting for your locationâ€¦</div>
  </aside>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin="anonymous"></script>
  <script>
    const $ = (sel) => document.querySelector(sel);

    let map, userMarker, searchCircle, markersLayer;
    const listEl = $('#list');
    const statusEl = $('#status');

    function setStatus(msg) { statusEl.textContent = msg; }

    function initMap(lat = 37.7749, lon = -122.4194, zoom = 14) {
      map = L.map('map').setView([lat, lon], zoom);
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 19,
        attribution: '&copy; OpenStreetMap contributors'
      }).addTo(map);
      markersLayer = L.layerGroup().addTo(map);
      userMarker = L.marker([lat, lon], { title: 'You' }).addTo(map).bindPopup('You are here');
      drawSearchCircle();
    }

    function drawSearchCircle() {
      const r = parseInt($('#radiusInput').value, 10) || 1000;
      const [lat, lon] = userMarker.getLatLng().toString().replace(/[()]/g,'').split(', ').map(Number);
      if (searchCircle) searchCircle.remove();
      searchCircle = L.circle([lat, lon], { radius: r, color: '#8be9fd', fillColor: '#8be9fd', fillOpacity: 0.08, weight: 1 }).addTo(map);
    }

    function updateUserLocation(lat, lon) {
      if (!map) initMap(lat, lon);
      userMarker.setLatLng([lat, lon]);
      map.setView([lat, lon]);
      drawSearchCircle();
    }

    function buildFiltersQL() {
      const parts = [];
      if ($('#wheelchairOnly').checked) parts.push('["wheelchair"~"^(yes|designated|limited)$"]');
      if ($('#changingOnly').checked) parts.push('["changing_table"~"^(yes|separate)$"]');
      if ($('#unisexOnly').checked) parts.push('["unisex"~"^(yes)$"];way["toilets:unisex"~"^(yes)$"]');
      return parts.join('');
    }

    async function search() {
      try {
        setStatus('Searching OpenStreetMapâ€¦');
        markersLayer.clearLayers();
        listEl.innerHTML = '';
        const r = parseInt($('#radiusInput').value, 10) || 1000;
        const { lat, lng } = userMarker.getLatLng();

        // Overpass QL query
        const filtersQL = buildFiltersQL();
        const query = `\n[out:json][timeout:25];\n(\n  node(around:${r},${lat},${lng})["amenity"="toilets"]${filtersQL};\n  way(around:${r},${lat},${lng})["amenity"="toilets"]${filtersQL};\n  relation(around:${r},${lat},${lng})["amenity"="toilets"]${filtersQL};\n);\nout center tags;`;

        const res = await fetch('https://overpass-api.de/api/interpreter', {
          method: 'POST',
          headers: { 'Content-Type': 'application/x-www-form-urlencoded; charset=UTF-8' },
          body: new URLSearchParams({ data: query })
        });
        if (!res.ok) throw new Error('Overpass error ' + res.status);
        const json = await res.json();
        const elements = json.elements || [];
        if (!elements.length) { setStatus('No bathrooms found in this radius. Try expanding your search.'); return; }

        const items = elements.map(el => {
          const c = el.center || { lat: el.lat, lon: el.lon };
          const t = el.tags || {};
          const name = t.name || 'Public toilet';
          const fee = t.fee ? `Fee: ${t.fee}` : null;
          const wheelchair = t.wheelchair ? `Wheelchair: ${t.wheelchair}` : null;
          const unisex = t.unisex === 'yes' || t['toilets:unisex'] === 'yes' ? 'Unisex: yes' : null;
          const changing = t.changing_table ? `Changing table: ${t.changing_table}` : null;
          const opening = t.opening_hours ? `Hours: ${t.opening_hours}` : null;
          const operator = t.operator ? `Operator: ${t.operator}` : null;
          const addr = [t['addr:housenumber'], t['addr:street']].filter(Boolean).join(' ') || t['addr:full'] || '';
          return { id: el.id, type: el.type, lat: c.lat, lon: c.lon, name, fee, wheelchair, unisex, changing, opening, operator, addr };
        });

        // Add markers & list
        items.forEach(item => {
          const m = L.marker([item.lat, item.lon]).addTo(markersLayer);
          const pill = (txt) => txt ? `<span class="pill">${txt}</span>` : '';
          const popup = `
            <div>
              <strong>${item.name}</strong><br/>
              ${item.addr ? item.addr + '<br/>' : ''}
              ${[item.wheelchair, item.unisex, item.changing, item.fee].filter(Boolean).map(p=>`<span class="pill">${p}</span>`).join(' ')}
              <div style="margin-top:6px" class="muted">${[item.opening, item.operator].filter(Boolean).join(' â€¢ ')}</div>
              <div style="margin-top:8px">
                <a target="_blank" rel="noopener" href="https://www.openstreetmap.org/${item.type}/${item.id}">OSM</a>
                Â· <a target="_blank" rel="noopener" href="https://www.google.com/maps/?q=${encodeURIComponent(item.name)}&daddr=${item.lat},${item.lon}">Directions</a>
              </div>
            </div>`;
          m.bindPopup(popup);

          const li = document.createElement('div');
          li.className = 'item';
          li.innerHTML = `
            <h4>${item.name}</h4>
            <div class="muted">${item.addr || `${item.lat.toFixed(5)}, ${item.lon.toFixed(5)}`}</div>
            <div style="margin-top:6px;">${[item.wheelchair, item.unisex, item.changing, item.fee].filter(Boolean).map(p=>`<span class='pill'>${p}</span>`).join(' ')}</div>
            <div style="margin-top:8px;">
              <button class="btn" data-go="${item.lat},${item.lon}">Pan</button>
              <a class="btn" style="text-decoration:none;" target="_blank" rel="noopener" href="https://www.google.com/maps/?q=${encodeURIComponent(item.name)}&daddr=${item.lat},${item.lon}">Directions</a>
            </div>`;
          li.querySelector('button[data-go]').addEventListener('click', (e) => {
            const [lat, lon] = e.currentTarget.dataset.go.split(',').map(Number);
            map.setView([lat, lon], 18);
          });
          listEl.appendChild(li);
        });

        setStatus(`${items.length} result${items.length!==1?'s':''} from OpenStreetMap. Tap a marker for details.`);
      } catch (err) {
        console.error(err);
        setStatus('Something went wrong fetching bathrooms. Try again, or increase the radius.');
      }
    }

    // Geolocation
    function locate() {
      if (!('geolocation' in navigator)) { initMap(); setStatus('Geolocation not supported. Showing San Francisco.'); return; }
      navigator.geolocation.getCurrentPosition(pos => {
        const { latitude, longitude } = pos.coords;
        updateUserLocation(latitude, longitude);
        search();
      }, err => {
        console.warn(err);
        initMap();
        setStatus('We couldn\'t get your location. You can still browse the map.');
      }, { enableHighAccuracy: true, timeout: 10000 });
    }

    // UI events
    $('#refreshBtn').addEventListener('click', () => { drawSearchCircle(); search(); });
    $('#radiusInput').addEventListener('change', drawSearchCircle);
    $('#wheelchairOnly').addEventListener('change', () => { drawSearchCircle(); search(); });
    $('#changingOnly').addEventListener('change', () => { drawSearchCircle(); search(); });
    $('#unisexOnly').addEventListener('change', () => { drawSearchCircle(); search(); });

    // Start
    locate();
  </script>
</body>
</html>
